<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LWFL Dashboard</title>
<style>
  :root{
    --bg:#f7f8fb; --card:#fff; --ink:#111827; --muted:#6b7280;
    --brand:#4f46e5; --brand2:#06b6d4; --good:#059669; --bad:#dc2626;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"}
  a{color:var(--brand);text-decoration:none}
  .wrap{max-width:1000px;margin:36px auto;padding:0 16px}

  /* Header */
  .titlecard{background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;border-radius:18px;padding:28px;box-shadow:0 10px 30px rgba(0,0,0,.12)}
  .titlecard h1{margin:0 0 6px;font-size:32px}
  .muted{color:#e5e7eb}
  .badge{display:inline-block;background:#eef2ff;color:#3730a3;border-radius:999px;padding:4px 10px;font-weight:700;font-size:12px;margin-left:8px}
  .titlecard .controls,
  .titlecard .controls label,
  .titlecard .controls strong {
    color: black !important;
  }

  /* Controls */
  .controls{display:flex;flex-wrap:wrap;gap:10px 16px;align-items:center;margin:12px 0 18px}
  .control{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:8px 12px;box-shadow:0 2px 8px rgba(0,0,0,.04);display:flex;align-items:center;gap:8px}
  select{border:1px solid #e5e7eb;border-radius:8px;padding:6px 10px;background:#fff}
  label.switch{display:flex;align-items:center;gap:8px;user-select:none}
  .small{font-size:12px;color:#6b7280}
  button.refresh{border:1px solid #e5e7eb;border-radius:8px;padding:6px 10px;background:#fff;cursor:pointer}

  /* Nav */
  .pillnav{position:sticky;top:0;z-index:10;background:rgba(247,248,251,.9);backdrop-filter:blur(6px);
    border-bottom:1px solid #e5e7eb;padding:8px 10px;margin:16px 0;border-radius:12px;box-shadow:0 6px 16px rgba(0,0,0,.05)}
  .pillnav a{display:inline-block;background:rgba(79,70,229,.1);color:var(--brand);padding:8px 12px;border-radius:999px;
    font-weight:600;font-size:13px;margin:6px 8px 6px 0}

  /* Layout */
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
  @media (max-width:860px){.grid{grid-template-columns:1fr}}
  .card{background:var(--card);border-radius:14px;padding:18px;box-shadow:0 6px 20px rgba(0,0,0,.08)}
  .card h2{margin:0 0 8px;display:flex;align-items:center;gap:10px}
  .logo{width:28px;height:28px;border-radius:6px;object-fit:cover;border:1px solid #e5e7eb;background:#fff}

  /* MVP */
  .mvp{display:flex;align-items:center;gap:12px;padding:12px;border:1px solid #e5e7eb;border-radius:12px;background:#fafbff;margin-bottom:10px}
  .good{color:var(--good);font-weight:700}

  /* Standings table */
  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  th{font-size:12px;text-transform:uppercase;letter-spacing:.04em;color:var(--muted);text-align:left;padding:0 10px}
  td{background:#f9fafb;padding:10px;border-radius:8px}
  .row{display:grid;grid-template-columns:28px 1fr 60px 60px 80px 80px;gap:10px;align-items:center}
  .mutedrow td{background:transparent;padding:0}
  .avatar{width:28px;height:28px;border-radius:50%;background:#e5e7eb;display:inline-block;vertical-align:middle}

  section[id]{scroll-margin-top:90px}
  @media print{ .pillnav{display:none} }
</style>
</head>
<body>
<div class="wrap">
  <section class="titlecard">
    <h1>LWFL Live Dashboard <span class="badge" id="weekBadge">Week â€“</span></h1>
    <div class="muted">Standings & weekly MVPs (top winning score) for Alpha and Omega.</div>
    <div class="controls">
      <div class="control">
        <strong>Week:</strong>
        <select id="weekSelect"></select>
        <span class="small" id="currentWeekNote"></span>
      </div>
      <div class="control">
        <label class="switch">
          <input type="checkbox" id="autoRefresh" checked />
          <span>Autoâ€‘refresh</span>
        </label>
        <span class="small" id="lastUpdated">Last updated: â€”</span>
        <button class="refresh" id="manualRefresh">Refresh now</button>
      </div>
    </div>
  </section>

  <nav class="pillnav">
    <a href="#alpha">Alpha Standings</a>
    <a href="#omega">Omega Standings</a>
  </nav>

  <div class="grid">
    <section id="alpha" class="card">
      <h2><img class="logo" src="https://static.wixstatic.com/media/804338_f498e0a83a7e4c53955da943493ce4d6~mv2.png" alt=""> Alpha League</h2>
      <div class="mvp" id="alphaMvp"><span class="small">Loading MVPâ€¦</span></div>
      <table>
        <thead>
          <tr class="mutedrow"><td colspan="6">
            <div class="row"><span></span><span>Team</span><span>W</span><span>L</span><span>PF</span><span>PA</span></div>
          </td></tr>
        </thead>
        <tbody id="alphaTable"></tbody>
      </table>
    </section>

    <section id="omega" class="card">
      <h2><img class="logo" src="https://static.wixstatic.com/media/804338_9571b11a8cf04cacb77b022d5c698610~mv2.png" alt=""> Omega League</h2>
      <div class="mvp" id="omegaMvp"><span class="small">Loading MVPâ€¦</span></div>
      <table>
        <thead>
          <tr class="mutedrow"><td colspan="6">
            <div class="row"><span></span><span>Team</span><span>W</span><span>L</span><span>PF</span><span>PA</span></div>
          </td></tr>
        </thead>
        <tbody id="omegaTable"></tbody>
      </table>
    </section>
  </div>
</div>

<script>
/*** ðŸ”§ CONFIG: your league IDs ***/
const ALPHA_LEAGUE_ID = "1264173731110998016";
const OMEGA_LEAGUE_ID = "1267775313601908736";

/*** Utilities ***/
const $ = sel => document.querySelector(sel);
const cdnAvatar = id => id ? `https://sleepercdn.com/avatars/thumbs/${id}` : "";
const toPts = (fpts, dec) => (Number(fpts||0) + Number((dec||0)/100)).toFixed(2);
const fmtTime = d => d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

/*** Current NFL display week (Sleeper state) ***/
async function getCurrentWeek() {
  const res = await fetch("https://api.sleeper.app/v1/state/nfl");
  const s = await res.json();
  return s.display_week || s.week || s.leg || 1;
}

/*** Build standings for a league ***/
async function buildStandings(leagueId, tableSel) {
  const [usersRes, rostersRes] = await Promise.all([
    fetch(`https://api.sleeper.app/v1/league/${leagueId}/users`),
    fetch(`https://api.sleeper.app/v1/league/${leagueId}/rosters`)
  ]);
  const [users, rosters] = [await usersRes.json(), await rostersRes.json()];

  // Map owner_id -> display/team name + avatar
  const byUser = {};
  for (const u of users) {
    const teamName = (u.metadata && (u.metadata.team_name || u.metadata.team_name_update)) || u.display_name || u.username;
    byUser[u.user_id] = { teamName, avatar: u.avatar };
  }

  const rows = rosters.map(r => {
    const u = byUser[r.owner_id] || {};
    const w = r.settings?.wins || 0;
    const l = r.settings?.losses || 0;
    const pf = toPts(r.settings?.fpts, r.settings?.fpts_decimal);
    const pa = toPts(r.settings?.fpts_against, r.settings?.fpts_against_decimal);
    return {
      roster_id: r.roster_id,
      teamName: u.teamName || `Team ${r.roster_id}`,
      avatar: u.avatar,
      w, l, pf: Number(pf), pa: Number(pa)
    };
  });

  // Sort: wins desc, PF desc, PA asc
  rows.sort((a,b)=> b.w - a.w || b.pf - a.pf || a.pa - b.pa);

  const tbody = $(tableSel);
  tbody.innerHTML = rows.map(r => `
    <tr><td colspan="6">
      <div class="row">
        <span><img class="avatar" src="${cdnAvatar(r.avatar)}" alt=""></span>
        <span><strong>${r.teamName}</strong></span>
        <span>${r.w}</span>
        <span>${r.l}</span>
        <span>${r.pf.toFixed(2)}</span>
        <span>${r.pa.toFixed(2)}</span>
      </div>
    </td></tr>
  `).join("");

  // Build quick roster_id -> teamName map for MVP labeling
  const byRoster = {};
  for (const r of rosters) {
    const u = byUser[r.owner_id] || {};
    byRoster[r.roster_id] = u.teamName || `Roster ${r.roster_id}`;
  }
  return byRoster;
}

/*** MVP: top winning team score for a given week ***/
async function findWeeklyTopWinner(leagueId, week) {
  const res = await fetch(`https://api.sleeper.app/v1/league/${leagueId}/matchups/${week}`);
  const matchups = await res.json();
  if (!Array.isArray(matchups) || matchups.length === 0) return null;

  // Group by matchup_id
  const byMatchup = new Map();
  for (const m of matchups) {
    if (!byMatchup.has(m.matchup_id)) byMatchup.set(m.matchup_id, []);
    byMatchup.get(m.matchup_id).push(m);
  }

  // Determine winner in each matchup, track best winner by points
  let best = null; // { roster_id, points }
  for (const [, games] of byMatchup) {
    if (!games || games.length === 0) continue;
    let winner = games[0];
    for (const g of games) {
      if ((g.points ?? 0) > (winner.points ?? 0)) winner = g;
    }
    const wPoints = Number(winner.points || 0);
    if (!best || wPoints > best.points) best = { roster_id: winner.roster_id, points: wPoints };
  }
  return best;
}

/*** Render MVP line ***/
function renderMvp(sel, mvp, rosterToTeam) {
  const el = $(sel);
  if (!mvp) { el.innerHTML = '<span class="small">No results yet for this week.</span>'; return; }
  const team = rosterToTeam[mvp.roster_id] || `Roster ${mvp.roster_id}`;
  el.innerHTML = `
    <div>
      <div class="small">Week MVP (Top Winning Score)</div>
      <div><strong>${team}</strong> <span class="good">+${mvp.points.toFixed(2)}</span></div>
    </div>
  `;
}

/*** Populate week selector (1â€“18), mark current week ***/
function populateWeekSelect(currentWeek){
  const sel = $("#weekSelect");
  sel.innerHTML = "";
  for (let w=1; w<=18; w++){
    const opt = document.createElement("option");
    opt.value = String(w);
    opt.textContent = (w === currentWeek) ? `Week ${w} (current)` : `Week ${w}`;
    sel.appendChild(opt);
  }
  sel.value = String(currentWeek);
  $("#weekBadge").textContent = `Week ${currentWeek}`;
  $("#currentWeekNote").textContent = `Current week: ${currentWeek}`;
}

/*** Load everything for a given week ***/
async function loadWeek(week){
  const [alphaMap, alphaMvp] = await Promise.all([
    buildStandings(ALPHA_LEAGUE_ID, "#alphaTable"),
    findWeeklyTopWinner(ALPHA_LEAGUE_ID, week)
  ]);
  renderMvp("#alphaMvp", alphaMvp, alphaMap);

  const [omegaMap, omegaMvp] = await Promise.all([
    buildStandings(OMEGA_LEAGUE_ID, "#omegaTable"),
    findWeeklyTopWinner(OMEGA_LEAGUE_ID, week)
  ]);
  renderMvp("#omegaMvp", omegaMvp, omegaMap);

  $("#lastUpdated").textContent = `Last updated: ${fmtTime(new Date())}`;
}

/*** Main ***/
(async function(){
  const currentWeek = await getCurrentWeek();
  populateWeekSelect(currentWeek);
  await loadWeek(currentWeek);

  // Week selector behavior
  $("#weekSelect").addEventListener("change", async (e)=>{
    const selWeek = Number(e.target.value);
    $("#weekBadge").textContent = `Week ${selWeek}${selWeek===currentWeek ? "" : ""}`;
    await loadWeek(selWeek);
  });

  // Auto-refresh behavior
  let timer = null;
  const startTimer = ()=>{
    stopTimer();
    timer = setInterval(async ()=>{
      const selWeek = Number($("#weekSelect").value);
      // Always refresh standings; MVPs for the selected week
      await loadWeek(selWeek);
    }, 120000); // 2 minutes
  };
  const stopTimer = ()=>{ if (timer) clearInterval(timer); timer = null; };

  $("#autoRefresh").addEventListener("change", (e)=>{
    if (e.target.checked) startTimer(); else stopTimer();
  });
  $("#manualRefresh").addEventListener("click", async ()=>{
    const selWeek = Number($("#weekSelect").value);
    await loadWeek(selWeek);
  });

  // Start timer by default
  startTimer();
})();
</script>
</body>
</html>
