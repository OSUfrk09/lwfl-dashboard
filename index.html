<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>LWFL Live Dashboard</title>
<style>
  :root{
    --bg:#f7f8fb; --card:#fff; --ink:#111827; --muted:#6b7280;
    --brand:#4f46e5; --brand2:#06b6d4; --good:#059669; --bad:#dc2626;
    --ring: rgba(79,70,229,.25);
    --fs: 14px; /* desktop/base font-size */
  }

  /* Base */
  * { box-sizing: border-box; }
  html { font-size: var(--fs); }
  body {
    margin: 0; padding: 0;
    background: var(--bg); color: var(--ink);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    -webkit-text-size-adjust: 100%;
    text-size-adjust: 100%;
  }
  img, svg, canvas, video { max-width: 100%; height: auto; }

  /* Fluid width on desktop, with a comfortable cap */
  .wrap {
    max-width: clamp(960px, 92vw, 1200px);  /* middle value controls fluidity */
    margin: 36px auto;
    padding: 0 16px;
  }

  /* Title card */
  .titlecard{
    background: linear-gradient(135deg,var(--brand),var(--brand2));
    color:#fff; border-radius:18px; padding:28px;
    box-shadow:0 10px 30px rgba(0,0,0,.12)
  }
  .titlecard h1{ margin:0 0 6px; font-size:32px }
  .muted{ color:#e5e7eb }
  .badge{
    display:inline-block; background:#eef2ff; color:#3730a3;
    border-radius:999px; padding:4px 10px; font-weight:700; font-size:12px; margin-left:8px
  }

  /* -------- Polished control bar -------- */
  .controlbar{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:12px;
    margin-top: 14px;
  }
  @media (max-width: 720px){
    .controlbar{ grid-template-columns: 1fr; }
  }
  .field{
    background: rgba(255,255,255,.92);
    border: 1px solid #e5e7eb;
    border-radius: 14px;
    padding: 10px 12px;
    box-shadow: inset 0 1px 0 rgba(255,255,255,.65), 0 2px 8px rgba(0,0,0,.06);
  }
  .label{
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: .04em;
    color: #475569;
    font-weight: 700;
    margin-bottom: 6px;
  }
  .input-row{
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 10px;
  }
  /* Capsule select */
  .select-wrap{
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 6px 10px;
    box-shadow: 0 1px 3px rgba(0,0,0,.04);
  }
  .select-wrap select{
    border: none;
    outline: none;
    background: transparent;
    font-size: 16px; /* prevent iOS zoom */
  }
  .inline-note{
    color: #6b7280;
    font-size: 12px;
  }
  /* Ghost button */
  .btn.ghost{
    background: #fff;
    border: 1px solid #dbe1f1;
    border-radius: 10px;
    padding: 8px 12px;
    box-shadow: 0 1px 3px rgba(0,0,0,.06);
    color: #2563eb;
    font-weight: 600;
    cursor: pointer;
  }
  .btn.ghost:hover{ background: #f5f7ff; }

  /* Minimal switch */
  .switch2{
    display: inline-flex;
    align-items: center;
    gap: 8px;
    -webkit-tap-highlight-color: transparent;
  }
  .switch2 input{
    appearance: none;
    width: 42px; height: 24px;
    border-radius: 999px;
    background: #e5e7eb;
    position: relative;
    outline: none;
    cursor: pointer;
    transition: background .2s ease;
    box-shadow: inset 0 0 0 1px rgba(0,0,0,.04);
  }
  .switch2 input::after{
    content: "";
    position: absolute; top: 3px; left: 3px;
    width: 18px; height: 18px; border-radius: 50%;
    background: #fff;
    box-shadow: 0 1px 2px rgba(0,0,0,.25);
    transition: transform .2s ease;
  }
  .switch2 input:checked{ background: #c7d2fe; }
  .switch2 input:checked::after{ transform: translateX(18px); }
  .switch2 .switch-text{ font-weight: 600; }

  /* Keep control text black inside titlecard */
  .titlecard .controlbar,
  .titlecard .controlbar * .label,
  .titlecard .controlbar strong{ color:#000 !important; }

  /* Pill nav */
  .pillnav{
    position:sticky; top:0; z-index:10;
    background:rgba(247,248,251,.9); backdrop-filter:blur(6px);
    border-bottom:1px solid #e5e7eb; padding:8px 10px; margin:16px 0;
    border-radius:12px; box-shadow:0 6px 16px rgba(0,0,0,.05)
  }
  .pillnav a{
    display:inline-block; background:rgba(79,70,229,.1); color:var(--brand);
    padding:8px 12px; border-radius:999px; font-weight:600; font-size:13px; margin:6px 8px 6px 0;
    transition: background .15s ease, box-shadow .15s ease;
    text-decoration: none !important;       /* remove underline */
  }
  .pillnav a:hover { background: rgba(79,70,229,.16); }
  .pillnav a:focus { outline: none; box-shadow: 0 0 0 3px var(--ring); text-decoration: none; }
  .pillnav a:visited { text-decoration: none; }

  /* Cards & grid */
  .grid{ display:grid; grid-template-columns:1fr 1fr; gap:18px }
  @media (max-width:860px){ .grid{ grid-template-columns:1fr } }
  .card{ background:var(--card); border-radius:14px; padding:18px; box-shadow:0 6px 20px rgba(0,0,0,.08) }
  .card h2{ margin:0 0 8px; display:flex; align-items:center; gap:10px }
  .logo{ width:28px; height:28px; border-radius:6px; object-fit:cover; border:1px solid #e5e7eb; background:#fff }

  /* MVP */
  .mvp{ display:flex; align-items:center; gap:12px; padding:12px; border:1px solid #e5e7eb; border-radius:12px; background:#fafbff; margin-bottom:10px }
  .good{ color:var(--good); font-weight:700 }

  /* Standings table */
  .table-wrap{ overflow-x:auto; -webkit-overflow-scrolling:touch; }
  table{ width:100%; border-collapse:separate; border-spacing:0 8px }
  th{ font-size:12px; text-transform:uppercase; letter-spacing:.04em; color:var(--muted); text-align:left; padding:0 10px }
  td{ background:#f9fafb; padding:10px; border-radius:8px }
  .row{
    display:grid;
    grid-template-columns:28px 1fr 60px 60px 80px 80px; /* avatar | team | W | L | PF | PA */
    gap:10px; align-items:center
  }
  .mutedrow td{ background:transparent; padding:0 }
  .avatar{ width:28px; height:28px; border-radius:50%; background:#e5e7eb; display:inline-block; vertical-align:middle }

  /* Anchor offset for sticky nav */
  section[id]{ scroll-margin-top: 90px; }

  /* Print */
  @media print{ .pillnav{ display:none } }

  /* --------- COMPACT MODE (Option B via JS) --------- */
  html.compact { --fs: 12px; }
  html.compact .wrap { padding: 0 12px; }
  html.compact .titlecard { padding: 18px; border-radius:16px; }
  html.compact .titlecard h1 { font-size: 26px; margin-bottom: 6px; }
  html.compact .badge { font-size: 11px; padding: 3px 8px; }
  html.compact .controlbar { gap: 10px; }
  html.compact .field { padding: 10px; }
  html.compact .small { font-size: 11px; }
  html.compact .pillnav { margin: 12px 0; padding: 6px 8px; }
  html.compact .card { padding: 14px; border-radius:12px; }
  html.compact .card h2 { font-size: 18px; gap: 8px; }
  html.compact .logo { width: 24px; height: 24px; }
  html.compact table { border-spacing: 0 6px; }
  html.compact td { padding: 8px; }
  html.compact .row { grid-template-columns: 22px 1fr 34px 34px 58px 58px; gap: 6px; }
  html.compact .avatar { width: 22px; height: 22px; }
  html.compact .mvp { padding: 10px; gap: 8px; }
</style>
</head>
<body>
<div class="wrap">
  <section class="titlecard">
    <h1>LWFL Live Dashboard <span class="badge" id="weekBadge">Week â€“</span></h1>
    <div class="muted">Standings & weekly MVPs (top winning score) for Alpha Lague and Omega League</div>

    <!-- Polished controls -->
    <div class="controlbar">
      <!-- Week -->
      <div class="field">
        <div class="label">Week</div>
        <div class="input-row">
          <div class="select-wrap">
            <select id="weekSelect"></select>
          </div>
          <span class="inline-note" id="currentWeekNote"></span>
        </div>
      </div>

      <!-- Live updates -->
      <div class="field">
        <div class="label">Live updates</div>
        <div class="input-row">
          <label class="switch2">
            <input type="checkbox" id="autoRefresh" checked />
            <span class="switch-text">Autoâ€‘refresh</span>
          </label>
          <span class="inline-note" id="lastUpdated">Last updated: â€”</span>
          <button class="btn ghost" id="manualRefresh">Refresh now</button>
        </div>
      </div>
    </div>
  </section>

  <nav class="pillnav">
    <a href="#alpha">Alpha Standings</a>
    <a href="#omega">Omega Standings</a>
  </nav>

  <div class="grid">
    <section id="alpha" class="card">
      <h2><img class="logo" src="https://static.wixstatic.com/media/804338_f498e0a83a7e4c53955da943493ce4d6~mv2.png" alt=""> Alpha League</h2>
      <div class="mvp" id="alphaMvp"><span class="small">No results yet for this week.</span></div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr class="mutedrow"><td colspan="6">
              <div class="row"><span></span><span>Team</span><span>W</span><span>L</span><span>PF</span><span>PA</span></div>
            </td></tr>
          </thead>
          <tbody id="alphaTable"></tbody>
        </table>
      </div>
    </section>

    <section id="omega" class="card">
      <h2><img class="logo" src="https://static.wixstatic.com/media/804338_9571b11a8cf04cacb77b022d5c698610~mv2.png" alt=""> Omega League</h2>
      <div class="mvp" id="omegaMvp"><span class="small">No results yet for this week.</span></div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr class="mutedrow"><td colspan="6">
              <div class="row"><span></span><span>Team</span><span>W</span><span>L</span><span>PF</span><span>PA</span></div>
            </td></tr>
          </thead>
          <tbody id="omegaTable"></tbody>
        </table>
      </div>
    </section>
  </div>
</div>

<script>
/*** One-time: enable compact mode on phones (Option B) ***/
(function () {
  const isMobile =
    window.matchMedia('(max-width: 480px)').matches ||
    /iPhone|Android.*Mobile|Mobile Safari/i.test(navigator.userAgent);
  if (isMobile) document.documentElement.classList.add('compact');
})();

/*** ðŸ”§ CONFIG: your league IDs ***/
const ALPHA_LEAGUE_ID = "1264173731110998016";
const OMEGA_LEAGUE_ID = "1267775313601908736";

/*** Utilities ***/
const $ = sel => document.querySelector(sel);
const cdnAvatar = id => id ? `https://sleepercdn.com/avatars/thumbs/${id}` : "";
const toPts = (fpts, dec) => (Number(fpts||0) + Number((dec||0)/100)).toFixed(2);
const fmtTime = d => d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

/*** Current NFL display week (Sleeper state) ***/
async function getCurrentWeek() {
  const res = await fetch("https://api.sleeper.app/v1/state/nfl");
  const s = await res.json();
  return s.display_week || s.week || s.leg || 1;
}

/*** Build standings for a league ***/
async function buildStandings(leagueId, tableSel) {
  const [usersRes, rostersRes] = await Promise.all([
    fetch(`https://api.sleeper.app/v1/league/${leagueId}/users`),
    fetch(`https://api.sleeper.app/v1/league/${leagueId}/rosters`)
  ]);
  const [users, rosters] = [await usersRes.json(), await rostersRes.json()];

  // Map owner_id -> display/team name + avatar
  const byUser = {};
  for (const u of users) {
    const teamName = (u.metadata && (u.metadata.team_name || u.metadata.team_name_update)) || u.display_name || u.username;
    byUser[u.user_id] = { teamName, avatar: u.avatar };
  }

  const rows = rosters.map(r => {
    const u = byUser[r.owner_id] || {};
    const w = r.settings?.wins || 0;
    const l = r.settings?.losses || 0;
    const pf = toPts(r.settings?.fpts, r.settings?.fpts_decimal);
    const pa = toPts(r.settings?.fpts_against, r.settings?.fpts_against_decimal);
    return {
      roster_id: r.roster_id,
      teamName: u.teamName || `Team ${r.roster_id}`,
      avatar: u.avatar,
      w, l, pf: Number(pf), pa: Number(pa)
    };
  });

  // Sort: wins desc, PF desc, PA asc
  rows.sort((a,b)=> b.w - a.w || b.pf - a.pf || a.pa - b.pa);

  const tbody = $(tableSel);
  tbody.innerHTML = rows.map(r => `
    <tr><td colspan="6">
      <div class="row">
        <span><img class="avatar" src="${cdnAvatar(r.avatar)}" alt=""></span>
        <span><strong>${r.teamName}</strong></span>
        <span>${r.w}</span>
        <span>${r.l}</span>
        <span>${r.pf.toFixed(2)}</span>
        <span>${r.pa.toFixed(2)}</span>
      </div>
    </td></tr>
  `).join("");

  // Build quick roster_id -> teamName map for MVP labeling
  const byRoster = {};
  for (const r of rosters) {
    const u = byUser[r.owner_id] || {};
    byRoster[r.roster_id] = u.teamName || `Roster ${r.roster_id}`;
  }
  return byRoster;
}

/*** MVP: top winning team score for a given week ***/
async function findWeeklyTopWinner(leagueId, week) {
  const res = await fetch(`https://api.sleeper.app/v1/league/${leagueId}/matchups/${week}`);
  const matchups = await res.json();
  if (!Array.isArray(matchups) || matchups.length === 0) return null;

  // Group by matchup_id
  const byMatchup = new Map();
  for (const m of matchups) {
    if (!byMatchup.has(m.matchup_id)) byMatchup.set(m.matchup_id, []);
    byMatchup.get(m.matchup_id).push(m);
  }

  // Determine winner in each matchup, track best winner by points
  let best = null; // { roster_id, points }
  for (const [, games] of byMatchup) {
    if (!games || games.length === 0) continue;
    let winner = games[0];
    for (const g of games) { if ((g.points ?? 0) > (winner.points ?? 0)) winner = g; }
    const wPoints = Number(winner.points || 0);
    if (!best || wPoints > best.points) best = { roster_id: winner.roster_id, points: wPoints };
  }
  return best;
}

/*** Render MVP line ***/
function renderMvp(sel, mvp, rosterToTeam) {
  const el = $(sel);
  if (!mvp) { el.innerHTML = '<span class="small">No results yet for this week.</span>'; return; }
  const team = rosterToTeam[mvp.roster_id] || `Roster ${mvp.roster_id}`;
  el.innerHTML = `
    <div>
      <div class="small">Week MVP (Top Winning Score)</div>
      <div><strong>${team}</strong> <span class="good">+${mvp.points.toFixed(2)}</span></div>
    </div>
  `;
}

/*** Populate week selector (1â€“18), mark current week ***/
function populateWeekSelect(currentWeek){
  const sel = $("#weekSelect");
  sel.innerHTML = "";
  for (let w=1; w<=18; w++){
    const opt = document.createElement("option");
    opt.value = String(w);
    opt.textContent = (w === currentWeek) ? `Week ${w} (current)` : `Week ${w}`;
    sel.appendChild(opt);
  }
  sel.value = String(currentWeek);
  $("#weekBadge").textContent = `Week ${currentWeek}`;
  $("#currentWeekNote").textContent = `Current week: ${currentWeek}`;
}

/*** Load everything for a given week ***/
async function loadWeek(week){
  const [alphaMap, alphaMvp] = await Promise.all([
    buildStandings(ALPHA_LEAGUE_ID, "#alphaTable"),
    findWeeklyTopWinner(ALPHA_LEAGUE_ID, week)
  ]);
  renderMvp("#alphaMvp", alphaMvp, alphaMap);

  const [omegaMap, omegaMvp] = await Promise.all([
    buildStandings(OMEGA_LEAGUE_ID, "#omegaTable"),
    findWeeklyTopWinner(OMEGA_LEAGUE_ID, week)
  ]);
  renderMvp("#omegaMvp", omegaMvp, omegaMap);

  $("#lastUpdated").textContent = `Last updated: ${fmtTime(new Date())}`;
}

/*** Main ***/
(async function(){
  const currentWeek = await getCurrentWeek();
  populateWeekSelect(currentWeek);
  await loadWeek(currentWeek);

  // Week selector behavior
  $("#weekSelect").addEventListener("change", async (e)=>{
    const selWeek = Number(e.target.value);
    $("#weekBadge").textContent = `Week ${selWeek}`;
    await loadWeek(selWeek);
  });

  // Auto-refresh behavior
  let timer = setInterval(async ()=>{
    const selWeek = Number($("#weekSelect").value);
    await loadWeek(selWeek);
  }, 120000); // 2 minutes

  $("#autoRefresh").addEventListener("change", (e)=>{
    if (e.target.checked) {
      if (!timer) timer = setInterval(async ()=>{
        const selWeek = Number($("#weekSelect").value);
        await loadWeek(selWeek);
      }, 120000);
    } else {
      clearInterval(timer);
      timer = null;
    }
  });

  $("#manualRefresh").addEventListener("click", async ()=>{
    const selWeek = Number($("#weekSelect").value);
    await loadWeek(selWeek);
  });
})();
</script>
</body>
</html>
